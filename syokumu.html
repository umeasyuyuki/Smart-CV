<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>職務経歴書 入力フォーム＋プレビュー</title>
  <!-- 外部CSS -->
  <link rel="stylesheet" href="syokumu.css">
  <!-- html2canvas と jsPDF をCDNから読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- 左カラム -->
    <div class="left">
      <div class="header-left">
        <h1>
          <span class="smart">Smart</span>
          <span class="dash">-</span>
          <span class="cv">CV</span>
        </h1>
        <h2>[完全無料] 履歴書・職務経歴書自動作成サービス</h2>
      </div>

      <!-- 選択ガイド -->
      <table class="choice-box">
        <tr>
          <td>
            <strong>
              既に経歴書をお持ちの方は、➀にお進みください（予想作成時間３０秒）<br>
              お持ちでない方は、②にお進みください。（予想作成時間５分）
            </strong>
          </td>
        </tr>
      </table>
      <table class="first-box">
        <tr>
          <td>
            <strong>➀に当てはまる方は、以下の項目への入力をお願いします。</strong>
          </td>
        </tr>
      </table>

      <!-- ファイルアップロード -->
      <div class="form-group upload-wrapper">
        <label for="resume-file" class="upload-label">
          1. 経歴書などをお持ちの場合アップロードしてください。
        </label>
        <div class="upload-area" onclick="document.getElementById('resume-file').click()">
          <p class="upload-text">
            PDFもしくは、docs形式のデータをアップロードしてください。
          </p>
        </div>
        <input type="file" id="resume-file" accept=".pdf,.doc,.docx" style="display: none">
      </div>

      <!-- 一括生成ボタン -->
      <button id="bulk-generate-btn" class="btn btn-primary">
        一括生成する
      </button>

      <table class="second-box">
        <tr>
          <td>
            <strong>②に当てはまる方は、以下の項目への入力をお願いします。</strong>
          </td>
        </tr>
      </table>

      <!-- 基本情報 -->
      <div class="section-title">基本情報</div>
      <div class="form-row">
        <div class="form-col">
          <label for="input-name">氏名</label>
          <input type="text" id="input-name" placeholder="例）山田 太郎">
        </div>
        <div class="form-col">
          <label for="input-tel">電話</label>
          <input type="text" id="input-tel" placeholder="例）090-1234-1234">
        </div>
        <div class="form-col">
          <label for="input-mail">メール</label>
          <input type="text" id="input-mail" placeholder="例）example@example.com">
        </div>
      </div>

      <!-- 職務要約 -->
      <div class="section-title">職務要約</div>
      <textarea class="simple-textarea" id="input-summary" placeholder="ここに職務要約を入力" maxlength="300"></textarea>
      <div id="char-counter">0 / 300字</div>
      
      <!-- 職歴 -->
      <div class="section-title">職務経歴</div>
      <div id="career-container">
        <!-- 最初の入力ブロック -->
        <div class="form-col" id="career-first">
          <label>期間</label>
          <input type="text" id="career1-period" placeholder="例）20xx年4月～20xx年xx月">
          <label>会社名</label>
          <input type="text" id="career1-company" placeholder="例）○○○株式会社">
          <label>雇用形態</label>
          <input type="text" id="career1-employment" placeholder="例）正社員">
          <label>役職</label>
          <input type="text" id="career1-position" placeholder="例）店長">
          <label>事業内容</label>
          <textarea id="career1-business" placeholder="例）オリジナル雑貨の企画・販売など"></textarea>
          <label>業務内容</label>
          <textarea id="career1-duty" placeholder="例）接客、売場管理、スタッフ育成など"></textarea>
          <label>実績</label>
          <textarea id="career1-achievement" placeholder="例）前年比105%達成など"></textarea>
          <label>従業員数</label>
          <input type="text" id="career1-empcount" placeholder="例）50名">
          <label>資本金</label>
          <input type="text" id="career1-capital" placeholder="例）2000万円">
          <label>株式市場</label>
          <input type="text" id="career1-market" placeholder="例）非上場">
        </div>
      </div>
      <div class="btn-group" id="career-btn-group">
        <button id="add-career-row">＋職務経歴を追加</button>
        <button id="remove-career-row">－削除</button>
      </div>

      <!-- 免許・資格 -->
      <div class="section-title">免許・資格</div>
      <div id="license-container">
        <div class="form-col" id="license-first">
          <label>年</label>
          <input type="text" id="license1-year" placeholder="例：2025">
          <label>月</label>
          <input type="text" id="license1-month" placeholder="例：01">
          <label>免許・資格名</label>
          <input type="text" id="license1-name" placeholder="例：普通自動車免許">
        </div>
      </div>
      <div class="btn-group" id="license-btn-group">
        <button id="add-license-row">＋免許・資格を追加</button>
        <button id="remove-license-row">－削除</button>
      </div>

      <!-- 語学 -->
      <div class="section-title">語学</div>
      <div id="lang-container">
        <div class="form-col" id="lang-first">
          <label>語学</label>
          <input type="text" id="lang1-lang" placeholder="例：英語">
          <label>レベル</label>
          <input type="text" id="lang1-level" placeholder="例：ビジネスレベル">
        </div>
      </div>
      <div class="btn-group" id="lang-btn-group">
        <button id="add-lang-row">＋語学を追加</button>
        <button id="remove-lang-row">－削除</button>
      </div>

      <!-- 活かせる経験・知識・技術 -->
      <div class="section-title">活かせる経験・知識・技術</div>
      <textarea class="simple-textarea" id="input-skill"></textarea>

      <!-- 自己PR -->
      <div class="section-title">自己PR</div>
      <textarea class="simple-textarea" id="input-pr"></textarea>

      <!-- PDFダウンロードボタンを中央寄せ -->
      <div style="text-align: center; margin-top: 24px;">
        <button id="download-pdf" style="padding:8px 16px; font-size:0.9rem; cursor:pointer; border-radius: 20px;">
          PDFダウンロード
        </button>
      </div>

    </div><!-- /left -->

    <!-- 右カラム（プレビュー） -->
    <div class="right">
      <div class="resume-pages-wrap" id="resumePages">
        <!-- JavaScriptでプレビュー内容が動的に生成されます -->
      </div>
    </div><!-- /right -->
  </div><!-- /container -->

  <!-- ★★★ ここから「コード2」のスクリプトを直接埋め込む ★★★ -->
  <script>
  /***************************************************
   * (A) 連携先URLなどの設定 (例：実際には適宜修正)
   ***************************************************/
  const scriptURL = "https://script.google.com/macros/u/2/s/AKfycbzJCzE2eCpXSnKWU0Q3papybktyrrQV3h74tD0yZyHwTPwmkFZPwXJvGCzHhoXaH3dNOg/exec"; // Google Apps Scriptなど
  const difyUploadURL = "https://api.dify.ai/v1/files/upload"; // 例
  const difyAPIKey = "app-nec0NdADJDdpecQKQYvtxzmD"; // ダミーキー

  /***************************************************
   * (B) グローバル変数
   ***************************************************/
  let selectedFile = null; // ユーザーがアップロード選択したファイル
  let uploadedFileURL = null; // 解析APIなどで生成されたファイルURLを格納

  /***************************************************
   * (C) ページ初期化
   ***************************************************/
  document.addEventListener('DOMContentLoaded', () => {
    console.log("[DEBUG] DOMContentLoaded: setting up...");

    const today = new Date();
    window.currentDateString = `${today.getFullYear()}年${String(today.getMonth()+1).padStart(2,'0')}月${String(today.getDate()).padStart(2,'0')}日`;

    // イベントバインド等セットアップ
    setupBindings();
    updatePreviewPages();

    // PDFダウンロード
    const pdfBtn = document.getElementById("download-pdf");
    if (pdfBtn) {
      pdfBtn.addEventListener('click', handleDownloadPDF);
    }

    // ファイルアップロード
    const fileInput = document.getElementById("resume-file");
    if (fileInput) {
      fileInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files.length > 0) {
          selectedFile = e.target.files[0];
          alert("ファイルが選択されました: " + selectedFile.name);
        }
      });
    }

    // ダウンロードボタン（アップロード済みファイル）
    const downloadBtn = document.getElementById("download-uploaded-file");
    if (downloadBtn) {
      downloadBtn.addEventListener("click", handleDownloadUploadedFile);
    }

    // 一括生成ボタン
    const bulkBtn = document.getElementById("bulk-generate-btn");
    if (bulkBtn) {
      bulkBtn.addEventListener("click", handleBulkGenerate);
    }

    // 職務要約の文字数カウント
    const summaryInput = document.getElementById("input-summary");
    const charCounter  = document.getElementById("char-counter");
    if (summaryInput && charCounter) {
      summaryInput.addEventListener("input", () => {
        const currentLength = summaryInput.value.length;
        charCounter.textContent = `${currentLength} / 300字`;
      });
    }

    console.log("[DEBUG] Initialization complete.");
  });

  /***************************************************
   * (D) 一括生成する (例：API解析)
   ***************************************************/
  async function handleBulkGenerate() {
    if (!selectedFile) {
      alert("ファイルが選択されていません。");
      return;
    }
    try {
      const formData = new FormData();
      formData.append("file", selectedFile);

      // 例：Dify APIに送る場合
      const response = await fetch(difyUploadURL, {
        method: 'POST',
        headers: { "x-api-key": difyAPIKey },
        body: formData
      });

      if (!response.ok) {
        const errText = await response.text();
        throw new Error("Difyへの送信に失敗: " + errText);
      }

      const result = await response.json();
      console.log("[DEBUG] Dify解析結果:", result);

      // APIの応答をフォームに反映（例）
      if (result.fileURL) {
        uploadedFileURL = result.fileURL;
      }
      if (result.name) {
        document.getElementById("input-name").value = result.name;
      }
      if (result.tel) {
        document.getElementById("input-tel").value = result.tel;
      }
      if (result.mail) {
        document.getElementById("input-mail").value = result.mail;
      }
      if (result.summary) {
        document.getElementById("input-summary").value = result.summary;
      }

      updatePreviewPages();
      alert("Dify解析結果をフォームに反映しました。");
    } catch (error) {
      console.error("[DEBUG] handleBulkGenerate error:", error);
      alert("エラーが発生しました: " + error.message);
    }
  }

  /***************************************************
   * (E) アップロード済みファイルのダウンロード (例)
   ***************************************************/
  function handleDownloadUploadedFile() {
    if (!uploadedFileURL) {
      alert("まだファイルがアップロードされていません。");
      return;
    }
    const a = document.createElement('a');
    a.href = uploadedFileURL;
    a.download = "";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  /***************************************************
   * (F) 入力フォームとプレビュー更新バインド
   ***************************************************/
  function setupBindings() {
    function bindText(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", updatePreviewPages);
    }

    // 基本情報
    bindText("input-name");
    bindText("input-tel");
    bindText("input-mail");

    // 職務要約
    bindText("input-summary");

    // 活かせる経験・知識・技術, 自己PR
    bindText("input-skill");
    bindText("input-pr");

    // 職歴（1つ目）
    bindText("career1-period");
    bindText("career1-company");
    bindText("career1-employment");
    bindText("career1-position");
    bindText("career1-business");
    bindText("career1-duty");
    bindText("career1-achievement");
    bindText("career1-empcount");
    bindText("career1-capital");
    bindText("career1-market");

    // ★ 免許・資格（初期表示分）★
    bindText("license1-year");
    bindText("license1-month");
    bindText("license1-name");

    // ★ 語学（初期表示分）★
    bindText("lang1-lang");
    bindText("lang1-level");

    // 職歴・免許・語学の追加/削除 (すでに定義済み)
    setupAddRemoveCareer();
    setupAddRemoveLicense();
    setupAddRemoveLang();
  }

  /***************************************************
   * (F+) ★ テーブルの上線だけ消す関数を追加 ★
   ***************************************************/
  function removeTableTopLine(wrapperElem) {
    const tables = wrapperElem.querySelectorAll("table");
    tables.forEach(table => {
      table.style.borderTop = "none";
    });
  }

  /***************************************************
   * (G) 職歴・免許・語学の 追加/削除
   ***************************************************/
  // ▼ 職歴 (同上: setupAddRemoveCareer)
  let careerCount = 1;
  function setupAddRemoveCareer() { /* ...省略（コードは上と同じ）... */ }

  // ▼ 免許・資格
  let licenseCount = 1;
  function setupAddRemoveLicense() { /* ...省略（コードは上と同じ）... */ }

  // ▼ 語学
  let langCount = 1;
  function setupAddRemoveLang() { /* ...省略（コードは上と同じ）... */ }

  /***************************************************
   * (H) 右カラムのプレビュー生成
   ***************************************************/
  function updatePreviewPages() { /* ...省略（コードは上と同じ）... */ }

  /***************************************************
   * (I) タイトルブロック
   ***************************************************/
  function makeTitleBlock() { /* ...省略（コードは上と同じ）... */ }
  function makeSectionTitle(txt) { /* ...省略（コードは上と同じ）... */ }

  /***************************************************
   * (J) 職歴ブロック
   ***************************************************/
  function makeCareerBlock(i) { /* ...省略（コードは上と同じ）... */ }

  /***************************************************
   * (K) 免許・資格テーブル
   ***************************************************/
  function makeLicenseTable(i) { /* ...省略（コードは上と同じ）... */ }

  /***************************************************
   * (L) 語学テーブル
   ***************************************************/
  function makeLangTable(i) { /* ...省略（コードは上と同じ）... */ }

  /***************************************************
   * (M) 補助関数
   ***************************************************/
  function docVal(id) { /* ...省略（コードは上と同じ）... */ }
  function esc(str) { /* ...省略（コードは上と同じ）... */ }
  function isOverflowAfterAppend(pageElem, blockElem) { /* ...省略（コードは上と同じ）... */ }

  /***************************************************
   * (N) PDFダウンロード処理
   ***************************************************/
  document.getElementById('download-pdf').addEventListener('click', async () => {
    // (A) まずスプレッドシートへ送信する
    const sendData = {
      createdDate: window.currentDateString || "",
      name: docVal('input-name'),
      tel:  docVal('input-tel'),
      mail: docVal('input-mail')
    };

    try {
      const response = await fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(sendData)
      });
      const resultText = await response.text();
      console.log("スプレッドシート送信結果:", resultText);
    } catch(e) {
      console.error("送信エラー:", e);
    }

    // (B) PDFをダウンロードする処理
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('portrait', 'pt', 'a4'); 
    const pages = document.querySelectorAll('.resume-page');

    for(let i=0; i<pages.length; i++){
      if(i>0) pdf.addPage();
      const canvas = await html2canvas(pages[i], { scale: 2 });
      const imgData = canvas.toDataURL('image/jpeg', 1.0);

      const pdfWidth  = pdf.internal.pageSize.getWidth();  
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidthPx  = canvas.width;
      const imgHeightPx = canvas.height;
      const scale = pdfWidth / imgWidthPx;
      const imgHeightInPdf = imgHeightPx * scale;
      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeightInPdf);
    }
    pdf.save('職務経歴書.pdf');
    alert("PDFダウンロードが開始されました！");
    console.log("[DEBUG] PDF download complete.");
  });
  </script>
</body>
</html>
